# This patch borrowed from https://github.com/NixOS/nixpkgs/pull/400347
From e32a27edc351e188df549efdcee3ca11bdb4af28 Mon Sep 17 00:00:00 2001
From: David McFarland <corngood@gmail.com>
Date: Sun, 20 Apr 2025 11:12:31 -0300
Subject: [PATCH] godot: disable autoPatchelf on $debug

Fixes: #399818
---
 pkgs/development/tools/godot/common.nix | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/pkgs/development/tools/godot/common.nix b/pkgs/development/tools/godot/common.nix
index dea54a9fd6384c..bab845d6af5da5 100644
--- a/pkgs/development/tools/godot/common.nix
+++ b/pkgs/development/tools/godot/common.nix
@@ -241,6 +241,14 @@ let
         runHook post Install
       '';
 
+    # patching $debug can crash patchelf
+    # (https://github.com/NixOS/patchelf/issues/373), so explicitly patch $out
+    dontAutoPatchelf = true;
+
+    postFixup = ''
+      autoPatchelf "$out"
+    '';
+
     passthru = {
       tests =
         let
